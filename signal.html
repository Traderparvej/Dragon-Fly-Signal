<script>
const utcSel=document.getElementById('utcSelect');
const marketSel=document.getElementById('market');
const tf=document.getElementById('timeframe');
const dateInp=document.getElementById('date');
const countInp=document.getElementById('count');
const assetSel=document.getElementById('asset');
const outDiv=document.getElementById('output');
const generateBtn=document.getElementById('generate');
const resetBtn=document.getElementById('reset');
const copyBtn=document.getElementById('copyOut');

const licenseModal=document.getElementById('licenseModal');
const submitLicense=document.getElementById('submitLicense');
const licenseKey=document.getElementById('licenseKey');
const licenseError=document.getElementById('licenseError');
const licenseContent=document.getElementById('licenseContent');
const expiredContent=document.querySelector('.modal .expired');

let licenseOk=false;
const LICENSE_KEY='dragonflyvip';
const LICENSE_DAYS=30;
let licenseExpiry=null;

const OTCpairs=[
"AUD/USD (OTC)","USD/BRL (OTC)","EUR/USD (OTC)","NZD/CAD (OTC)","USD/ARS (OTC)","AUD/CAD (OTC)","CAD/JPY (OTC)","USD/IDR (OTC)","EUR/GBP (OTC)","USD/BDT (OTC)","USD/PHP (OTC)","USD/EGP (OTC)","EUR/CHF (OTC)","EUR/AUD (OTC)","USD/ZAR (OTC)","AUD/CHF (OTC)","AUD/JPY (OTC)","CAD/CHF (OTC)","CHF/JPY (OTC)","EUR/CAD (OTC)","EUR/JPY (OTC)","GBP/AUD (OTC)","NZD/CHF (OTC)","USD/CAD (OTC)","USD/CHF (OTC)","USD/COP (OTC)","USD/INR (OTC)","USD/JPY (OTC)","USD/MXN (OTC)","USD/NGN (OTC)","USD/PKR (OTC)","AUD/NZD (OTC)","EUR/SGD (OTC)","GBP/JPY (OTC)","USD/TRY (OTC)","EUR/NZD (OTC)","GBP/NZD (OTC)","NZD/USD (OTC)","GBP/CHF (OTC)","GBP/CAD (OTC)","GBP/USD (OTC)"
];
const REALpairs=['EUR/JPY','USD/JPY','CAD/JPY','NZD/USD','EUR/USD','GBP/USD','AUD/JPY','GBP/CAD','USD/CAD','AUD/CAD','AUD/USD','GBP/AUD','GBP/JPY','USD/CHF','EUR/GBP'];

function fillAssetPairs(){
  assetSel.innerHTML='';
  const pairs=marketSel.value==='REAL'? REALpairs:OTCpairs;
  pairs.forEach(p=>{
    const opt=document.createElement('option');
    opt.value=p; opt.text=p;
    assetSel.appendChild(opt);
  });
}
fillAssetPairs();
marketSel.addEventListener('change',fillAssetPairs);

function fmtDate(d){return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;}
function pad2(n){return String(n).padStart(2,'0');}
function randDir(){return Math.random()>0.5?'𝙲𝙰𝙻':'𝙿𝚄𝚃';}

// Latin → Monospace converter
function mono(str){
  const map = {
    "A":"𝙰","B":"𝙱","C":"𝙲","D":"𝙳","E":"𝙴","F":"𝙵","G":"𝙶","H":"𝙷","I":"𝙸","J":"𝙹",
    "K":"𝙺","L":"𝙻","M":"𝙼","N":"𝙽","O":"𝙾","P":"𝙿","Q":"𝚀","R":"𝚁","S":"𝚂","T":"𝚃",
    "U":"𝚄","V":"𝚅","W":"𝚆","X":"𝚇","Y":"𝚈","Z":"𝚉",
    "a":"𝚊","b":"𝚋","c":"𝚌","d":"𝚍","e":"𝚎","f":"𝚏","g":"𝚐","h":"𝚑","i":"𝚒","j":"𝚓",
    "k":"𝚔","l":"𝚕","m":"𝚖","n":"𝚗","o":"𝚘","p":"𝚙","q":"𝚚","r":"𝚛","s":"𝚜","t":"𝚝",
    "u":"𝚞","v":"𝚟","w":"𝚠","x":"𝚡","y":"𝚢","z":"𝚣",
    "0":"𝟶","1":"𝟷","2":"𝟸","3":"𝟹","4":"𝟺","5":"𝟻","6":"𝟼","7":"𝟽","8":"𝟾","9":"𝟿",
    "-":"-"
  };
  return str.split("").map(ch=>map[ch]||ch).join("");
}

function buildSignals(count){
  const out=[];
  const asset=assetSel.value || 'USD/JPY';
  let cursor=new Date();
  for(let i=0;i<count;i++){
    cursor=new Date(cursor.getTime()+(2+Math.floor(Math.random()*4))*60000);
    const time=`${pad2(cursor.getHours())}:${pad2(cursor.getMinutes())}`;
    let pair=asset.toUpperCase()
                  .replace("/","")
                  .replace(" ","")
                  .replace("(OTC)","-OTC");
    out.push(`${mono("M1")} ${mono(pair)} ${mono(time)} ${randDir()}`);
  }
  return out;
}

function tfText(tfVal){
  if(tfVal.endsWith("m")) return tfVal.replace("m"," minutes");
  if(tfVal.endsWith("h")) return tfVal.replace("h"," hours");
  return tfVal;
}

function generateOutput(){
  const now=new Date().getTime();
  if(!licenseOk){
    licenseModal.style.display='flex';
    return;
  }
  if(licenseExpiry && now>licenseExpiry){
    licenseContent.style.display='none';
    expiredContent.style.display='block';
    licenseModal.style.display='flex';
    return;
  }
  outDiv.textContent="⏳ Generating... (10s)";
  setTimeout(()=>{
    const dateStr=dateInp.value?fmtDate(new Date(dateInp.value)):fmtDate(new Date());
    const count=Number(countInp.value||8);
    const signals=buildSignals(count);

    let lines=[];
    lines.push(`DATE: ${dateStr}\n`);
    lines.push(`⏰ UTC ${utcSel.value} ;  MTG :- 1 STEP\n`);
    lines.push(`              🐉DragonFly 🐉\n`);
    lines.push(`⌛️ ${tfText(tf.value)} :- \n`);
    lines.push(signals.join("\n"));
    lines.push(`\nSoftware:DragonFly\nOwner: @TraderParvej`);
    outDiv.textContent=lines.join('\n');
  },1000);
}

submitLicense.addEventListener('click',()=>{
  if(licenseKey.value.trim()===LICENSE_KEY){
    licenseOk=true;
    licenseExpiry=new Date().getTime()+30*24*60*60*1000;
    licenseModal.style.display='none';
    licenseContent.style.display='block';
    expiredContent.style.display='none';
    generateOutput();
  }else{
    licenseError.style.display='block';
  }
});

generateBtn.addEventListener('click',generateOutput);
resetBtn.addEventListener('click',()=>{outDiv.textContent='▶️ DATE: — ◀️\n\n(Press Generate to produce signals)';});
copyBtn.addEventListener('click',()=>{navigator.clipboard.writeText(outDiv.textContent);copyBtn.textContent='Copied ✔';setTimeout(()=>copyBtn.textContent='Copy Output',1000);});
</script>
