<script>
const utcSel=document.getElementById('utcSelect');
const marketSel=document.getElementById('market');
const tf=document.getElementById('timeframe');
const dateInp=document.getElementById('date');
const countInp=document.getElementById('count');
const assetSel=document.getElementById('asset');
const outDiv=document.getElementById('output');
const generateBtn=document.getElementById('generate');
const resetBtn=document.getElementById('reset');
const copyBtn=document.getElementById('copyOut');

const licenseModal=document.getElementById('licenseModal');
const submitLicense=document.getElementById('submitLicense');
const licenseKey=document.getElementById('licenseKey');
const licenseError=document.getElementById('licenseError');
const licenseContent=document.getElementById('licenseContent');
const expiredContent=document.querySelector('.modal .expired');

let licenseOk=false;
const LICENSE_KEY='dragonflyvip';
const LICENSE_DAYS=30;
let licenseExpiry=null;

const OTCpairs=[
"AUD/USD (OTC)","USD/BRL (OTC)","EUR/USD (OTC)","NZD/CAD (OTC)","USD/ARS (OTC)","AUD/CAD (OTC)","CAD/JPY (OTC)","USD/IDR (OTC)","EUR/GBP (OTC)","USD/BDT (OTC)","USD/PHP (OTC)","USD/EGP (OTC)","EUR/CHF (OTC)","EUR/AUD (OTC)","USD/ZAR (OTC)","AUD/CHF (OTC)","AUD/JPY (OTC)","CAD/CHF (OTC)","CHF/JPY (OTC)","EUR/CAD (OTC)","EUR/JPY (OTC)","GBP/AUD (OTC)","NZD/CHF (OTC)","USD/CAD (OTC)","USD/CHF (OTC)","USD/COP (OTC)","USD/INR (OTC)","USD/JPY (OTC)","USD/MXN (OTC)","USD/NGN (OTC)","USD/PKR (OTC)","AUD/NZD (OTC)","EUR/SGD (OTC)","GBP/JPY (OTC)","USD/TRY (OTC)","EUR/NZD (OTC)","GBP/NZD (OTC)","NZD/USD (OTC)","GBP/CHF (OTC)","GBP/CAD (OTC)","GBP/USD (OTC)"
];
const REALpairs=['EUR/JPY','USD/JPY','CAD/JPY','NZD/USD','EUR/USD','GBP/USD','AUD/JPY','GBP/CAD','USD/CAD','AUD/CAD','AUD/USD','GBP/AUD','GBP/JPY','USD/CHF','EUR/GBP'];

function fillAssetPairs(){
  assetSel.innerHTML='';
  const pairs=marketSel.value==='REAL'? REALpairs:OTCpairs;
  pairs.forEach(p=>{
    const opt=document.createElement('option');
    opt.value=p; opt.text=p;
    assetSel.appendChild(opt);
  });
}
fillAssetPairs();
marketSel.addEventListener('change',fillAssetPairs);

function fmtDate(d){return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;}
function pad2(n){return String(n).padStart(2,'0');}
function randDir(){return Math.random()>0.5?'ð™²ð™°ð™»':'ð™¿ðš„ðšƒ';}

// Latin â†’ Monospace converter
function mono(str){
  const map = {
    "A":"ð™°","B":"ð™±","C":"ð™²","D":"ð™³","E":"ð™´","F":"ð™µ","G":"ð™¶","H":"ð™·","I":"ð™¸","J":"ð™¹",
    "K":"ð™º","L":"ð™»","M":"ð™¼","N":"ð™½","O":"ð™¾","P":"ð™¿","Q":"ðš€","R":"ðš","S":"ðš‚","T":"ðšƒ",
    "U":"ðš„","V":"ðš…","W":"ðš†","X":"ðš‡","Y":"ðšˆ","Z":"ðš‰",
    "a":"ðšŠ","b":"ðš‹","c":"ðšŒ","d":"ðš","e":"ðšŽ","f":"ðš","g":"ðš","h":"ðš‘","i":"ðš’","j":"ðš“",
    "k":"ðš”","l":"ðš•","m":"ðš–","n":"ðš—","o":"ðš˜","p":"ðš™","q":"ðšš","r":"ðš›","s":"ðšœ","t":"ðš",
    "u":"ðšž","v":"ðšŸ","w":"ðš ","x":"ðš¡","y":"ðš¢","z":"ðš£",
    "0":"ðŸ¶","1":"ðŸ·","2":"ðŸ¸","3":"ðŸ¹","4":"ðŸº","5":"ðŸ»","6":"ðŸ¼","7":"ðŸ½","8":"ðŸ¾","9":"ðŸ¿",
    "-":"-"
  };
  return str.split("").map(ch=>map[ch]||ch).join("");
}

function buildSignals(count){
  const out=[];
  const asset=assetSel.value || 'USD/JPY';
  let cursor=new Date();
  for(let i=0;i<count;i++){
    cursor=new Date(cursor.getTime()+(2+Math.floor(Math.random()*4))*60000);
    const time=`${pad2(cursor.getHours())}:${pad2(cursor.getMinutes())}`;
    let pair=asset.toUpperCase()
                  .replace("/","")
                  .replace(" ","")
                  .replace("(OTC)","-OTC");
    out.push(`${mono("M1")} ${mono(pair)} ${mono(time)} ${randDir()}`);
  }
  return out;
}

function tfText(tfVal){
  if(tfVal.endsWith("m")) return tfVal.replace("m"," minutes");
  if(tfVal.endsWith("h")) return tfVal.replace("h"," hours");
  return tfVal;
}

function generateOutput(){
  const now=new Date().getTime();
  if(!licenseOk){
    licenseModal.style.display='flex';
    return;
  }
  if(licenseExpiry && now>licenseExpiry){
    licenseContent.style.display='none';
    expiredContent.style.display='block';
    licenseModal.style.display='flex';
    return;
  }
  outDiv.textContent="â³ Generating... (10s)";
  setTimeout(()=>{
    const dateStr=dateInp.value?fmtDate(new Date(dateInp.value)):fmtDate(new Date());
    const count=Number(countInp.value||8);
    const signals=buildSignals(count);

    let lines=[];
    lines.push(`DATE: ${dateStr}\n`);
    lines.push(`â° UTC ${utcSel.value} ;  MTG :- 1 STEP\n`);
    lines.push(`              ðŸ‰DragonFly ðŸ‰\n`);
    lines.push(`âŒ›ï¸ ${tfText(tf.value)} :- \n`);
    lines.push(signals.join("\n"));
    lines.push(`\nSoftware:DragonFly\nOwner: @TraderParvej`);
    outDiv.textContent=lines.join('\n');
  },1000);
}

submitLicense.addEventListener('click',()=>{
  if(licenseKey.value.trim()===LICENSE_KEY){
    licenseOk=true;
    licenseExpiry=new Date().getTime()+30*24*60*60*1000;
    licenseModal.style.display='none';
    licenseContent.style.display='block';
    expiredContent.style.display='none';
    generateOutput();
  }else{
    licenseError.style.display='block';
  }
});

generateBtn.addEventListener('click',generateOutput);
resetBtn.addEventListener('click',()=>{outDiv.textContent='â–¶ï¸ DATE: â€” â—€ï¸\n\n(Press Generate to produce signals)';});
copyBtn.addEventListener('click',()=>{navigator.clipboard.writeText(outDiv.textContent);copyBtn.textContent='Copied âœ”';setTimeout(()=>copyBtn.textContent='Copy Output',1000);});
</script>
